"""
Django settings for scimma_admin project.

Generated by 'django-admin startproject' using Django 3.0.6.

For more information on this file, see
https://docs.djangoproject.com/en/3.0/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.0/ref/settings/
"""

import pprint
import os
import boto3
import requests
import configparser
import datetime
import json
from rest_authtoken.settings import AUTH_TOKEN_VALIDITY



CI_LOG={}  # log config actions here


def get_literal_ci(item_name):
    value  = os.getenv(item_name)
    CI_LOG[item_name] = value
    return value

def get_aws_db_ci(item_name):
    """
    Return a dictionary with database info in the format
    DJANGO expects.

    IF item_name is is in the environment, populate the structure
    with information from AWS.
    IF item_name  not in the environmemt, return an strcture  where
    the AWS information is null. Later config staps must fill it out.

    https://docs.djangoproject.com/en/3.0/ref/settings/#databases
    """
    # make an (mostly) empty template
    database_ci  = {
        "ENGINE" : "django.db.backends.postgresql",
        "PASSWORD" : None,
        "NAME" : None,
        "USER" : None, 
        "HOST" : None,
        "PORT" : None
    }
    
    # fillout from AWS if the item_name is a defined environment variable
    db_instance_id = os.getenv(item_name)
    if db_instance_id:
        rds = boto3.client("rds", region_name="us-west-2")
        rds_db = rds.describe_db_instances(
        Filters=[{"Name": "db-instance-id", "Values": [db_instance_id]},]
        )
        rds_db = rds_db["DBInstances"][0]
        database_ci["NAME"] = rds_db["DBName"]
        database_ci["USER"] = rds_db["MasterUsername"]
        database_ci["HOST"] = rds_db["Endpoint"]["Address"]
        database_ci["PORT"] = rds_db["Endpoint"]["Port"]
    CI_LOG[item_name] = f"{item_name} yelds {database_ci}"
    return database_ci
         
def get_aws_secret_ci(item_name):
    secret_ci = None
    name = os.getenv(item_name)
    if name:
        sm = boto3.client("secretsmanager", region_name="us-west-2")
        secret_ci = sm.get_secret_value(SecretId=name)["SecretString"]
        CI_LOG[item_name] = f"from {item_name}={name} obtained {'*'*len(secret_ci)}"
    else :
        CI_LOG[item_name] = f"{item_name} not in configuration"
    return secret_ci
    
def truth(str):
    "convert ascii value to python boolean"
    if str ==  "true" : return True
    if str ==  "false" : return False
    raise RuntimeError(f"bad truth string:  {str}")



# ELB is extremely picky about the headers on HTTP 301 responses for them to be correctly passed
# back to the client. This custom middleware tries to keep it happy.
def set_redirect_headers(get_response):
    def middleware(request):
        response = get_response(request)
        if response.status_code == 301:
            response["who"] = 'don-test-301'
            response["Content-Type"] = '*/*; charset="UTF-8"'
            response["Content-Length"] = 0
        return response

    return middleware

"""
SCIMMA_ENVIRONMENT = os.environ.get("SCIMMA_ENVIRONMENT", default="local")

_aws_name_prefixes = {
    "local": None,  # AWS variables are not used for local testing
    "dev": "",  # this is empty for historical reasons, it should probably be renamed in future
    "prod": "prod-",
}

if not SCIMMA_ENVIRONMENT in _aws_name_prefixes.keys():
    raise RuntimeError(f"Specified environment ({SCIMMA_ENVIRONMENT}) is not known")


AWS_NAME_PREFIX = _aws_name_prefixes[SCIMMA_ENVIRONMENT]
LOCAL_TESTING = SCIMMA_ENVIRONMENT == "local"

print("SCIMMA_ENVIRONMENT:", SCIMMA_ENVIRONMENT)
print("AWS_NAME_PREFIX:", AWS_NAME_PREFIX)
print("LOCAL_TESTING:", LOCAL_TESTING)
"""

# Build paths inside the project like this: os.path.join(BASE_DIR, ...)
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.0/howto/deployment/checklist/

### settings.py name : SECRET_KEY
### CI_Name(aws)     : SECRET_KEY_SECRET_NAME
### CI_Name(literal)): SECRET_KEY
### What is it       : A secret used internally by django to encrypt things.
### Why Config       : prod and dev deployment get the secret key  from AWS
### Why Config       : LOCAL_DEV just makes one up ("zzzlocal") as its' transient.
### SECURITY WARNING: keep the secret key used in production secret!

SECRET_KEY = get_aws_secret_ci("SECRET_KEY_SECRET_NAME")
if key := get_literal_ci("SECRET_KEY") : SECRET_KEY = key
print("SECRET_KEY", SECRET_KEY)


###settings.py Name : SYMPA_CREDS
###CI_Name(aws)     : SYMPA_CREDS_SECRET_NAME
###CI_Name(literal) : SYMPA_CREDS
####What is it      : credentials to access SYMPA.
###What is it       : ALSO  flag indicating to not activate ...
###What is it       : ... sympa access IF SET TO {}
### Why Config      : to indicate whther to access SYMPA.
### WHy Config      : To authenticate to Symps 

SYMPA_CREDS = get_aws_secret_ci("SYMPA_CREDS_SECRET_NAME")
if key := get_literal_ci("SYMPA_CREDS") : SYMPA_CREDS = json.loads(key)
print("SYMPA_CREDS", SYMPA_CREDS)

### Settings.py name: SECURE_SSL_REDIRECT
### CI_Name          : SECURE_SSL_REDIRECT 
### What is it : causes django re redirect http to https automatically if true. 
### Why Config : Some development is simpler of done on http, to avoind the work of setting u  https stuff.
SECURE_SSL_REDIRECT = truth(get_literal_ci("SECURE_SSL_REDIRECT"))


### settings.py Name : DEBUG
### CI_Name          : DJANGO_DEBUG
### What is it       : true-> DEBUG  false -> INFO
### Why Config       : debug can be useful in development, DEBUG must not be used in prod.
### Normal Default   : INFO
### SECURITY WARNING: don't run with debug turned on in production!
DJANGO_DEBUG = truth(get_literal_ci("DJANGO_DEBUG"))

# This looks scary, but it's OK because we always run behind a load balancer
# which verifies the HTTP Host header for us. In production, that's an EKS Load
# Balancer.
ALLOWED_HOSTS = ["*"]

# Application definition

try:
    os.stat(os.path.join(BASE_DIR, "home"))
    HAVE_WEBSITE = True
except FileNotFoundError:
    HAVE_WEBSITE = False

INSTALLED_APPS = [
    "hopskotch_auth",
    "whitenoise.runserver_nostatic",
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "mozilla_django_oidc",
    "django_bootstrap5",
    "crispy_forms",
    "crispy_bootstrap5",
    "rest_framework",
    "rest_authtoken",
]
if HAVE_WEBSITE:
    INSTALLED_APPS.insert(0, "home.apps.HomeConfig")

CRISPY_ALLOWED_TEMPLATE_PACKS = "bootstrap5"

CRISPY_TEMPLATE_PACK = "bootstrap5"

MIDDLEWARE = [
    "scimma_admin.settings.set_redirect_headers",  # must be placed before SecurityMiddleware to modify redirects
    "django.middleware.security.SecurityMiddleware",
    "whitenoise.middleware.WhiteNoiseMiddleware",  # Placement after SecurityMiddleware needed as per whitenoise docs
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
    "hopskotch_auth.api_views.set_scram_auth_info_header",
]

ROOT_URLCONF = "scimma_admin.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    },
]

WSGI_APPLICATION = "scimma_admin.wsgi.application"

# Magic to work around https://code.djangoproject.com/ticket/27813#comment:7
# Fix courtesy of Daniele Varrazzo via
# https://www.postgresql.org/message-id/CA%2Bmi_8Zy50LYof%3DFfO9qybeQJfoLPpUXCand8CBvapS%3DXoCkGg%40mail.gmail.com
# and Patrick Heyer via https://github.com/modoboa/modoboa-amavis/issues/115#issuecomment-479141344
# This is needed because Django (dubiously) decides that it must sort things in order to delete them,
# leading to the surprising result that types must have a defined order in order to be deleted.
def fix_psycopg_binary():
    try:
        import psycopg2
    except ImportError:
        # Fall back to psycopg2cffi
        from psycopg2cffi import compat

        compat.register()
        import psycopg2

    def bytea2bytes(value, cur):
        if value is None:
            return None
        buf = psycopg2.BINARY(value.encode("utf-8"), cur)
        if buf is not None:
            return buf.tobytes()

    BYTEA2BYTES = psycopg2.extensions.new_type(
        psycopg2.BINARY.values, "BYTEA2BYTES", bytea2bytes
    )
    psycopg2.extensions.register_type(BYTEA2BYTES)


# Database

DATABASES = {}
#### CI_Name(literal) : ARCHIVE_DB__NAME
### What is it : The Name of the archive DB instance
### Why Config : Different DB's are used in proc, dev, and elocal dev seneraio
DATABASES["archive"] = get_aws_db_ci("ARCHIVE_DB_INSTANCE_NAME")

#### CI_Name(literal) : ADMIN_DB__overrides (many)
### What is it : Parameters to allow stand alone local development....
### What is it : or r/o access via a tunnel for local development....
### Why Config : Support multiple use scenarios.
if ci := get_literal_ci("ARCHIVE_DB_NAME") : DATABASES["archive"]["NAME"] = ci
if ci := get_literal_ci("ARCHIVE_DB_USER") : DATABASES["archive"]["USER"] = ci
if ci := get_literal_ci("ARCHIVE_DB_HOST") : DATABASES["archive"]["HOST"] = ci
if ci := get_literal_ci("ARCHIVE_DB_PORT") : DATABASES["archive"]["PORT"] = ci
if ci := get_literal_ci("ARCHIVE_TUNNEL_LOCAL_PORT") : DATABASES["archive"]["PORT"] = ci
if ci := get_literal_ci("ARCHIVE_TUNNEL_LOCAL_HOST") : DATABASES["archive"]["HOST"] = ci

###CI_Name(aws)     : ARCHIVE_DB_PASSWORD_SECRET_NAME 
###CI_Name(literal) : ARCHIVE_DB_PASSWORD
####What is it      : password to the database 
### Why Config      : each DB has a distinct password
DATABASES["archive"]["PASSWORD"] = get_aws_secret_ci("ARCHIVE_DB_PASSWORD_SECRET_NAME")
if ci := get_literal_ci("ARCHIVE_DB_PASSWORD") : DATABASES["archive"]["PASSWORD"] = ci


### CI_Name(literal) : ADMIN_DB__NAME
### What is it : The Name of the admin DB instance
### Why Config : Different DB's are used in proc, dev, and elocal dev seneraio
DATABASES["default"] = get_aws_db_ci("ADMIN_DB_INSTANCE_NAME")

#### CI_Name(literal) : ADMIN_DB__overrides (many)
### What is it : Parameters to allow stand alone local development....
### What is it : or r/o access via a tunnel for local development....
### Why Config : Support multiple use scenarios.
if ci := get_literal_ci("ADMIN_DB_NAME") : DATABASES["default"]["NAME"] = ci
if ci := get_literal_ci("ADMIN_DB_USER") : DATABASES["default"]["USER"] = ci
if ci := get_literal_ci("ADMIN_DB_HOST") : DATABASES["default"]["HOST"] = ci
if ci := get_literal_ci("ADMIN_DB_PORT") : DATABASES["default"]["PORT"] = ci
if ci := get_literal_ci("ADMIN_TUNNEL_LOCAL_PORT") : DATABASES["default"]["PORT"] = ci
if ci := get_literal_ci("ADMIN_TUNNEL_LOCAL_HOST") : DATABASES["default"]["HOST"] = ci

###CI_Name(aws)     : ADMIN_DB_PASSWORD_SECRET_NAME 
###CI_Name(literal) : ADMIN_DB_PASSWORD
####What is it      : password to the database 
### Why Config      : each DB has a distinct password
DATABASES["default"]["PASSWORD"] = get_aws_secret_ci("ADMIN_DB_PASSWORD_SECRET_NAME")
if ci := get_literal_ci("ADMIN_DB_PASSWORD") : DATABASES["default"]["PASSWORD"] = ci


if DATABASES["default"]["ENGINE"] == "django.db.backends.postgresql":
    fix_psycopg_binary()

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

# Authentication
# https://mozilla-django-oidc.readthedocs.io/en/stable/settings.html
OIDC_OP_AUTHORIZATION_ENDPOINT = (
    "https://login.scimma.org/realms/SCiMMA/protocol/openid-connect/auth"
)
OIDC_OP_TOKEN_ENDPOINT = (
    "https://login.scimma.org/realms/SCiMMA/protocol/openid-connect/token"

)
OIDC_OP_USER_ENDPOINT = (
    "https://login.scimma.org/realms/SCiMMA/protocol/openid-connect/userinfo"
)

OIDC_OP_JWKS_ENDPOINT = (
    "https://login.scimma.org/realms/SCiMMA/protocol/openid-connect/certs"
)
AUTHENTICATION_BACKENDS = ("hopskotch_auth.auth.HopskotchOIDCAuthenticationBackend",)

### Settings.py name : OIDC_OP_USER_ENDPOINT
### CI_NAME          : OIDC_OP_USER_ENDPOINT
### What is it       : WHere Django goes to fetch "CLAIMS" about a user to compare...
### What is it       : given the "identiy" provided when it was a Op_CLIENT..
### Why config       : we want production database for AWS  but...
### Why config       : we want to simulate this in local for developement flex...
### Why config       : e.g spoof uses, invistiagate new claims etc.  e.g. poor man's dev keycloak.
### Example setting  : 'https://login.scimma.org/realms/SCiMMA/protocol/openid-connect/userinfo'
### Example setting  : (bypass keycloak for local dev) http://localhost:8001'
OIDC_OP_USER_ENDPOINT=get_literal_ci("OIDC_OP_USER_ENDPOINT")

### Settings.py name : OIDC_OP_CLIENT_ID
### CI_NAME          : OIDC_OP_CLIENT_ID_SECRET_NAME
### CI_NAME          : OIDC_OP_CLIENT_ID_SECRET_NAME
### What is it       : Identifies acimmm-admin app to the identity provider.
### Why config       : AWS inscalletion use keycloak 
### Why config       : For local devlepoemt no authentication is needed..
### Example setting  : 
OIDC_OP_CLIENT_ID = get_aws_secret_ci('OIDC_OP_CLIENT_ID_SECRET_NAME')
if ci := get_literal_ci("OIDC_OP_CLIENT_ID") : OIDC_OP_CLIENT_ID = ci

"""
if not LOCAL_TESTING:
    OIDC_RP_CLIENT_ID = get_secret(AWS_NAME_PREFIX + "scimma-admin-keycloak-client-id")
    OIDC_RP_CLIENT_SECRET = get_secret(
        AWS_NAME_PREFIX + "scimma-admin-keycloak-client-secret"
    )
else:
    OIDC_RP_CLIENT_ID = "cilogon:/client_id/79be6fcf2057dbc381dfb8ba9c17d5fd"
    #get_localdev_secret("cilogon_client_secret")
"""
OIDC_RP_SIGN_ALGO = "RS256"

### Settings.py name : OIDC_RP_CLIENT_ID
### CI_Name          : OIDC_RP_CLIENT_ID
### What is it : scimma-admin  app is a client to  OIDC provider...
### Example setting  : scimma-admin-keycloak-client-id"
### Example setting  : cilogon:/client_id/79be6fcf2057dbc381dfb8ba9c17d5fd'
OIDC_RP_CLIENT_ID = get_literal_ci("OIDC_RP_CLIENT_ID")


### CI_Name(aws)      : OIDC_RP_CLIENT_SECRET_SECRET_NAME
### CI_Name(literal)  : OIDC_RP_CLIENT_SECRET
### What is it : A secret to access the OIDC provider specifed in client_id.
### Example setting  : scimma-admin-keycloak-client-secret
### Example setting  : scimma-admin-cilogon-localdev-client-secret
OIDC_RP_CLIENT_SECRET = get_aws_secret_ci("OIDC_RP_CLIENT_SECRET_SECRET_NAME")
if key := get_literal_ci("OIDC_RP_CLIENT_SECRET") : OIDC_RP_CLIENT_SECRET = key # talk to Chris.


LOGIN_URL = "/hopauth/login"

LOGIN_REDIRECT_URL = "/services"
if HAVE_WEBSITE:
    LOGOUT_REDIRECT_URL = "/"
else:
    LOGOUT_REDIRECT_URL = "/hopauth/logout"
LOGIN_REDIRECT_URL_FAILURE = "/hopauth/login_failure"

# Internationalization
# https://docs.djangoproject.com/en/3.0/topics/i18n/

LANGUAGE_CODE = "en-us"

TIME_ZONE = "America/Los_Angeles"

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.0/howto/static-files/

STATICFILES_STORAGE = "whitenoise.storage.CompressedManifestStaticFilesStorage"
STATIC_ROOT = os.path.join(BASE_DIR, "staticfiles")
STATIC_URL = "/static/"

# Logging
LOGGING = {
    "version": 1,
    "disable_existing_loggers": False,
    "handlers": {
        "console": {"class": "logging.StreamHandler", "formatter": "console",},
    },
    "root": {"handlers": ["console"], "level": "INFO",},
    "loggers": {
        "django": {
            "handlers": ["console"],
            "level": "DEBUG" if DJANGO_DEBUG else "INFO",
            "propagate": False,
        },
        "django.db.backends": {"level": "INFO",},
    },
    "formatters": {
        "console": {
            "format": "%(asctime)s %(levelname)s [%(name)s:%(lineno)s] %(module)s %(process)d %(thread)d %(message)s",
        },
    },
}


# TLS termination is handled by an AWS ALB in production
SECURE_PROXY_SSL_HEADER = ("HTTP_X_FORWARDED_PROTO", "https")

### Settings.py name : KAFKA_USER_AUTH_GROUP
### CI_Name          : KAFKA_USER_AUTH_GROUP
### What is it       : The name of the group in Keycloak that idenfies users authorized to use HOP. 
### Why Config       : dunno we have one keycloak and apparently one group shared between dev and prod
KAFKA_USER_AUTH_GROUP=get_literal_ci("KAFKA_USER_AUTH_GROUP")

# For now we work with just one mailing list, so it gets to be a setting by itself
OPENMMA_MAILINGLIST = "openmma@lists.scimma.org"

SCRAM_EXCHANGE_TTL = datetime.timedelta(minutes=15)

REST_TOKEN_TTL = AUTH_TOKEN_VALIDITY

REST_FRAMEWORK = {
    "DEFAULT_PARSER_CLASSES": ["rest_framework.parsers.JSONParser",],
    "DEFAULT_AUTHENTICATION_CLASSES": ("rest_authtoken.auth.AuthTokenAuthentication",),
}

### Settings.py name : KAFKA_BROKER_URL
### CI_Name          : KAFKA_BROKER_URL
### What is it : The URL to a kafka Broker 
### Why Config : dev and prod use different instances
### dev.hop.scimma.org or kafka.scimma.org for the AWS versions

KAFKA_BROKER_URL=get_literal_ci("KAFKA_BROKER_URL")

import pprint
print('************************  Configuration report ****************')
pprint.pp(DATABASES)
pprint.pp(CI_LOG)
print('************************  Configuration report ****************')


#try:
#    from local_settings import *
#except ImportError:
#    pass
