{% extends "hopskotch_auth/base.html" %}
{% load bootstrap4 tz %}
{% block title %}Home{% endblock %}

{% block page-style %}
{% endblock %}

{% block page-header %}
<script>
    $(function () {
      $('[data-toggle="popover"]').popover()
      })
</script>
{% endblock %}

{% block page-body %}
    <section class="creds-list">
      <h2>Active credentials</h2>
      <table class="table table-hover table-bordered">
        <thead>
          <tr>
            <th scope="col">Kafka Username</th>
            <th scope="col">Created On (Pacific Time)</th>
            <th scope="col">Description</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for cred in credentials %}
          <tr>
            <td scope="row">{{ cred.username }}</td>
            <td>{{ cred.created_at|localtime }}</td>
            <td>{{ cred.description }}</td>
            <td>
              <form action="{% url 'edit_credential' %}" method="get">
                <input type="hidden" value="{{ cred.username }}" name="cred_username">
                <input class="btn btn-secondary" type="submit" value="Edit">
              </form>
              <form action="{% url 'delete' %}">
                {% csrf_token %}
                <input type="hidden" value="{{ cred.username }}" name="cred_username">
                <input class="btn btn-danger" type="submit" value="Delete">
              </form>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td class="info" colspan="4">No existing credentials found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>
    <hr/>
    <section class="create">
      <h2>Create credentials</h2>
      <p>Click below to create a new set of Kafka credentials.</p>
      <p>A username and password will be generated for you.</p>
      <form action="{% url 'create' %}" method="post">
        {% csrf_token %}
        <input class="btn btn-outline-primary" type="submit" value="Create new credentials">
      </form>
    </section>
    <hr/>
    <section class="groups-list">
      <h2>Group memberships</h2>
      <table class="table table-hover table-bordered">
        <thead>
          <tr>
            <th scope="col">Group Name</th>
            <th scope="col">Membership Status</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for membership in memberships %}
          <tr>
            <td>{{ membership.group_name }}</td>
            <td>{{ membership.status }}</td>
            <td>
                {% if membership.status|stringformat:"s" == "Owner" %}
                <form action="{% url 'edit_group' %}" method="get">
                    <input type="hidden" name="group_id" value="{{ membership.group_id }}">
                    <input type="submit" value="Edit">
                </form>
                {% endif %}
                {% if request.user.is_staff %}
                <form action="{% url 'delete_group' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="group_id" value="{{ membership.group_id }}">
                    <input type="submit" value="Delete">
                </form>
                {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td class="info" colspan="3">This account does not currently belong to any groups.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <hr/>
    <section class="topics-list">
      <h2>Accessible Topics</h2>
      <table class="table table-hover table-bordered">
        <thead>
          <tr>
            <th scope="col">Topic Name</th>
            <th scope="col">Description</th>
            <th scope="col">Access Type
                <button type="button" class="btn btn-outline-info btn-sm" data-toggle="popover"
                    title="Help" data-content="An access type of 'public' indicates a topic which
                    can be read by any user, with any credential. An access type of 'via group'
                    means that you have access to the topic because access is granted to
                    one of the groups in which you are a member. However, to use this access, you
                    must additionally grant it to oe of your credentials.">?</button>
            </th>
          </tr>
        </thead>
        <tbody>
          {% for topic in accessible_topics %}
          <tr>
            <td>{{ topic.name }}</td>
            <td>{{ topic.description }}</td>
            <td>{{ topic.access_type }}</td>
          </tr>
          {% empty %}
          <tr>
            <td class="info" colspan="3">This account does not have access to any topics</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <hr/>
    {% if request.user.is_staff %}
    <section class="group-management">
      <h2>Manage groups</h2>
      <form action="{% url 'group_management' %}" method="get">
          <input class="btn btn-outline-primary" type="submit" value="Manage Groups">
      </form>
    </section>
    <hr/>
    <section class="topic-management">
      <h2>Manage topics</h2>
      <form action="{% url 'topic_management' %}" method="get">
          <input class="btn btn-outline-primary" type="submit" value="Manage Topics">
      </form>
    </section>
    <hr/>
    <section class="cred-management">
      <h2>Manage credentials</h2>
      <form action="{% url 'credential_management' %}" method="get">
          <input class="btn btn-outline-primary" type="submit" value="Manage Credentials">
      </form>
    </section>
    {% endif %}
{% endblock %}
